### Let's Exploit: Magento < 1.9.2.3!

#### Why?

A [friend of mine] sent me an [interesting advisory] the other day, 
demonstrating that there was an XSS exploit for the eCommerce platform 
Magento. I like security advisories, mainly because it's an interesting 
challenge and a good way to learn more about the underlying frameworks 
you're using. Since it was a lot of fun to [exploit wordpress], I 
figure'd I'd try out this XSS exploit. It should go without saying, but 
don't try this on systems that aren't yours, or you'll be violating the 
[law]. 

#### The plan

As pointed out in the [interesting advisory], this is a flaw that has to 
be triggered by an administrator checking on an order. So in our pretend 
scenario we have two types of exploits going on:

1. Taking advantage of the vulnerability itself 
2. Convincing the admin to check your order

Both of these are likely to be fairly easy given the nature of Magento. 
Calling or emailing an adminstrator in reference to your order would get 
any well-intentioned admin to check it out. And the first is trivially 
done according to the advisery, by using the quoted form of an email 
address for your client account. So our attack plan is simple: 

1. Setup our server to receive information
2. Perform exploit and call up our friendly admin
3. Steal their credentials or perform actions under their name

#### Setup

First off, we need to download a version of magento that isn't patched, 
so we can grab any copy of magento that is less than 1.9.2.3 from the 
[downloads page]. I had to create an account to download the software, 
so do that if you need to (use [guerrillamail] if you need a quick 
email address to use). Then [setup magento]. In my case I'll be using 
[apache] with the following host setup:

	# My New Magento Install! Nothing bad could happen :D 
	<VirtualHost *:80>
	    Servername local.magento.sec
	    ErrorLog /tmp/error.log
	    DocumentRoot /path/to/magento
	    <Directory /path/to/magento >
	        Options Indexes FollowSymLinks MultiViews
	        AllowOverride All
	        Order allow,deny
	        allow from all
	    </Directory>
	</VirtualHost>

	#My Evil domain that will exploit the poor thing:
	<VirtualHost *:80>
	    Servername local.evil.sec
		CustomLog /tmp/exploit.log combined
	    DocumentRoot /tmp
	    <Directory /tmp >
	        Order allow,deny
	        allow from all
	    </Directory>
	</VirtualHost>


And then setup your hosts file appropriately:

	127.0.0.1 local.magento.sec local.evil.sec

And starting up apache and navigating to your local site should give you 
the installation screen and you can follow the instructions to [setup magento].
In my case, I had to update some permissions and install the php5-gd 
package on my system before being able to run magento. Your mileage may 
vary.

#### Confirming the exploit

Before we do anything complicated, we want to perform a smoke test to 
make sure that we can trigger the problem ourselves. We'll do the same 
test that the advisory did and simple alert on the page by using the 
email `"><script>alert(1);</script>"@sucuri.net`


[friend of mine]:http://www.seancperkins.com
[interesting advisory]:https://blog.sucuri.net/2016/01/security-advisory-stored-xss-in-magento.html
[downloads page]:https://www.magentocommerce.com/download
[exploit wordpress]:/tech-blog/compromising-wordpress
[law]:http://www.leginfo.ca.gov/cgi-bin/displaycode?section=pen&group=00001-01000&file=484-502.9
[guerrillamail]:https://www.guerrillamail.com/
[setup magento]:https://www.siteground.com/tutorials/magento/magento_installation.htm
[apache]:https://www.apache.org/