<!DOCTYPE HTML>
<html>
 <head>
  <title>
   Ethan's Tech Blog | 'Caught in the Spiders Web' -- A googlebot Heisenbug
  </title>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="An interesting bug occured today, and it was all googles fault..." name="description"/>
  <meta content="Ethan Eldridge" name="author"/>
  <meta content="googlebot,spider,Heisenbug,spiders,bugs,software development,urls visited without a user" name="keywords"/>
  <meta content="index, follow" name="robots"/>
  <meta content="1 month" name="revisit-after"/>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="icon" type="image/ico"/>
  <!-- Facebook Open Graph Tags -->
  <meta content="Ethan Eldridge | 'Caught in the Spiders Web' -- A googlebot Heisenbug" property="og:title"/>
  <meta content="article" property="og:type"/>
  <meta content="//static2.ethanjoachimeldridge.info/ethan.jpeg" property="og:image"/>
  <meta content="http://www.ethanjoachimeldridge.info/" property="og:url"/>
  <meta content="An interesting bug occured today, and it was all googles fault..." property="og:description"/>
  <!-- Twitter Card Tags -->
  <meta content="summary" name="twitter:card"/>
  <meta content="Ethan Eldridge | 'Caught in the Spiders Web' -- A googlebot Heisenbug" name="twitter:title"/>
  <meta content="An interesting bug occured today, and it was all googles fault..." name="twitter:description"/>
  <meta content="//static2.ethanjoachimeldridge.info/ethan.jpeg" name="twitter:image"/>
  <!-- Core CSS Scripts -->
  <link href="//css.ethanjoachimeldridge.info/style.css" integrity="sha384-N5yYwPDw4cymKjw0SjwRTKGAR4pv2PWn7wUtflWwszx/tkL1rEaVQyalmX2tM3wO" rel="stylesheet"/>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52103053-1', 'www.ethanjoachimeldridge.info');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
  </script>
 </head>
 <body>
  <header>
   <h1>
    'Caught in the Spiders Web' -- A googlebot Heisenbug
   </h1>
  </header>
  <div id="content">
   <a href="/tech-blog">
    Back
   </a>
   <h3>
    The Invisible Hand of Google
   </h3>
   <p>
    Today I ran into one of the more interesting bugs I've seen recently. The problem
started occuring when a work client's site started seeming to misbehave. Namely,
their voucher system was redeeming themselves it seemed.
   </p>
   <p>
    So we started looking at it and noticed that the redemptions were occuring pretty 
soon after they were purchased. Setting up a test deal, we started recreating the
problem on the live site (I tried futilely to trace the steps and perform the same
sequence on my local environment to no avail.), with this success (recreating the 
problem is the first step in debugging) I began inserting logging around the area
of the database that handled the updates.
   </p>
   <p>
    Soon enough we saw the tell-tale logs come through, but they didn't make any sense.
Our tester had taken no action, and hadn't done anything that would have caused
any response from the page. So, I took the next logical step: something automated was 
going on.
   </p>
   <p>
    I checked the cron logs for anything suspicious, then moved to triggering the jobs
themselves to look for anything strange. Finally, I threw the sledge hammer at it
and threw in this gem:
   </p>
   <pre><code>hs_log("FROM UPDATE: $id " .('server::' . print_r($_SERVER,1)) . ('GETS::' . print_r($_GET,1)) . ('POST::' . print_r($_POST,1)), 1 );
</code></pre>
   <p>
    And had our tester run through the bug producing sequence one more time. Then I 
waited for the large amount of arrays to fly by my screen. Stopped it, snagged it,
and copy pasted it to my text editor for inspection.
   </p>
   <p>
    I burst out laughing when I saw it --
    <code>
     [HTTP_FROM] =&gt; googlebot(at)googlebot.com\n
    </code>
    The problem was from a spider! Here's what had happened: One of the ways redemption
is done on this client's site is through QR codes. When the QR code is followed, 
the voucher is instantly redeemed. It's an easy process for the person having
their voucher redeemed and is speedy overall, the problem is that just by following
the link that the QR code represents the voucher is marked redeemed.
   </p>
   <p>
    So what had been happening was that google had looked the page for the voucher,
then saw the link for the QR code, and innocently followed that link trying to
index the website. The fix of course was simple:
   </p>
   <pre><code>if(isset($_SERVER['HTTP_FROM'])){
    if(strpos($_SERVER['HTTP_FROM'], 'google') !== false){
        hs_log("PROTECTED FROM GOOGLE SPIDERS",1);
        return;
    }
}
</code></pre>
   <p>
    Within the code that decides to redeem the voucher form the QR code or not. It 
was an interesting bug to find, and thankfully an easy one to fix. The php check
is there as a safeguard and a robots.txt will follow to tell the spiders to lay 
off.
   </p>
   <h3>
    Other Posts
   </h3>
   <div id="other-posts">
    <ul>
     <li>
      <a href="custom-permalinks-for-custom-templates">
       Custom Permalinks for Custom Tables and Pages
      </a>
     </li>
     <li>
      <a href="harpjs-macros">
       HarpJS and Macros, Static Delivery for Static Content
      </a>
     </li>
     <li>
      <a href="xml-sitemap-for-harpjs">
       XML Sitemap for Harp JS
      </a>
     </li>
     <li>
      <a href="item-processor-example">
       Spring Batch ItemProcessListener Example
      </a>
     </li>
     <li>
      <a href="bgi">
       BGI, a way to track your spending
      </a>
     </li>
     <li>
      <a href="serial-hill-climber-golang">
       Serial Hill Climber in GoLang
      </a>
     </li>
    </ul>
   </div>
   <div id="disqus_thread">
   </div>
   <script type="text/javascript">
    var disqus_shortname = 'ejehardenberg';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
   </script>
   <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
     comments powered by Disqus.
    </a>
   </noscript>
   <a class="dsq-brlink" href="http://disqus.com">
    <!--
-->
    comments powered by
    <span class="logo-disqus">
     Disqus
    </span>
   </a>
  </div>
  <nav>
   <ul>
    <li>
     <a href="/index">
      <img height="32px" src="//static1.ethanjoachimeldridge.info/california.jpg" width="32px"/>
      <!--
-->
      <span>
       Home
      </span>
     </a>
    </li>
    <li>
     <a href="/about">
      <img height="32px" src="//static2.ethanjoachimeldridge.info/ethan.jpeg" width="32px"/>
      <!--
-->
      <span>
       About me
      </span>
     </a>
    </li>
    <li>
     <a href="/projects">
      <img height="32px" src="//static3.ethanjoachimeldridge.info/project.png" width="32px"/>
      <!--
-->
      <span>
       Projects
      </span>
     </a>
    </li>
    <li>
     <a href="/resume">
      <img height="32px" src="//static4.ethanjoachimeldridge.info/cv.png" width="32px"/>
      <!--
-->
      <span>
       Resume
      </span>
     </a>
    </li>
    <li>
     <a href="/tech-blog">
      <img height="32px" src="//static5.ethanjoachimeldridge.info/tech-blog.png" width="32px"/>
      <!--
-->
      <span>
       Tech Blog
      </span>
     </a>
    </li>
    <li>
     <a href="/cooking">
      <img height="32px" src="//static6.ethanjoachimeldridge.info/cooking.jpg" width="32px"/>
      <!--
-->
      <span>
       Cooking
      </span>
     </a>
    </li>
    <li>
     <a href="/writing">
      <img height="32px" src="//static7.ethanjoachimeldridge.info/writing.png" width="32px"/>
      <!--
-->
      <span>
       Writing
      </span>
     </a>
    </li>
    <li>
     <a href="/contact">
      <img height="32px" src="//static.ethanjoachimeldridge.info/contact.png" width="32px"/>
      <!--
-->
      <span>
       Contact
      </span>
     </a>
    </li>
    <li>
     <a href="/writing/political">
      <img height="32px" src="//static1.ethanjoachimeldridge.info/politics.png" width="32px"/>
      <!--
-->
      <span>
       Opinion
      </span>
     </a>
    </li>
    <li>
     <a href="https://github.com/EdgeCaseBerg">
      <img height="32px" src="//static2.ethanjoachimeldridge.info/github.png" width="32px"/>
      <!--
-->
      <span>
       Github
      </span>
     </a>
    </li>
    <li>
     <a href="https://twitter.com/TheR3dLily">
      <img height="32px" src="//static3.ethanjoachimeldridge.info/twitter-bird-light-bgs.png" width="32px"/>
      <!--
-->
      <span>
       @TheR3dLily
      </span>
     </a>
    </li>
    <li>
     <a href="http://www.linkedin.com/profile/view?id=151414806">
      <img height="32px" src="//static4.ethanjoachimeldridge.info/LinkedIn_logo.png" width="32px"/>
      <!--
-->
      <span>
       LinkedIn
      </span>
     </a>
    </li>
   </ul>
  </nav>
 </body>
</html>