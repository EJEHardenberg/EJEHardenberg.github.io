<!DOCTYPE HTML>
<html>
 <head>
  <title>
   Ethan's Tech Blog | Deny spam emails from registering in WordPress
  </title>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="It only takes a single function to mitigate spam accounts clogging your database with spam users." name="description"/>
  <meta content="Ethan Eldridge" name="author"/>
  <meta content="spam,mitigation,wordpress.register,domainnames,email,my_simple_domain_check" name="keywords"/>
  <meta content="index, follow" name="robots"/>
  <meta content="1 month" name="revisit-after"/>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="icon" type="image/ico"/>
  <!-- Facebook Open Graph Tags -->
  <meta content="Ethan Eldridge | Deny spam emails from registering in WordPress" property="og:title"/>
  <meta content="article" property="og:type"/>
  <meta content="//static2.ethanjoachimeldridge.info/ethan.jpeg" property="og:image"/>
  <meta content="http://www.ethanjoachimeldridge.info/" property="og:url"/>
  <meta content="It only takes a single function to mitigate spam accounts clogging your database with spam users." property="og:description"/>
  <!-- Twitter Card Tags -->
  <meta content="summary" name="twitter:card"/>
  <meta content="Ethan Eldridge | Deny spam emails from registering in WordPress" name="twitter:title"/>
  <meta content="It only takes a single function to mitigate spam accounts clogging your database with spam users." name="twitter:description"/>
  <meta content="//static2.ethanjoachimeldridge.info/ethan.jpeg" name="twitter:image"/>
  <!-- Core CSS Scripts -->
  <link href="//css.ethanjoachimeldridge.info/style.css" integrity="sha384-N5yYwPDw4cymKjw0SjwRTKGAR4pv2PWn7wUtflWwszx/tkL1rEaVQyalmX2tM3wO" rel="stylesheet"/>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52103053-1', 'www.ethanjoachimeldridge.info');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
  </script>
 </head>
 <body>
  <header>
   <h1>
    Deny spam emails from registering in WordPress
   </h1>
  </header>
  <div id="content">
   <a href="/tech-blog">
    Back
   </a>
   <h3>
    Denying known spam accounts on WordPress
   </h3>
   <p>
    Let's say you've made a WordPress site, you're pretty happy about it, and you've 
decided you want to talk to your readership via comments. But you don't want any 
anonymous comments or to use disqus, and instead you want people to register on 
your website. So you enable registration for everyone and write your posts.
   </p>
   <p>
    Fast forward a few months and suddenly you've got 10,000 users registered but 
half of them are random spam accounts. You start looking through and notice 
that a lot of the domain names for the websites end in russian domains, or have 
domain names outside of what you're used to seeing, such as .ru, .li, .website.
   </p>
   <p>
    This isn't that hard to do with the wordpress filter
    <code>
     registration_errors
    </code>
    and 
an implementation is rather simple:
   </p>
   <pre><code>function my_simple_domain_check($errors, $sanitized_user_login, $user_email) {
    //fill out this list with any problem domains
    $spamdomains = array(
        '.li',
        '.website',
        '.ru'
    );
    $ip = isset($_SERVER['X-Forwarded-For']) ? $_SERVER['X-Forwarded-For'] : (isset($_SERVER['HTTP_X_FORWARDED_FOR']) ? $_SERVER['HTTP_X_FORWARDED_FOR'] : $_SERVER['REMOTE_ADDR']);
    foreach ($spamdomains as $domain) {
        if ( strpos($user_email, $domain) !== false ) {
            $errors-&gt;add( 'spam_error', __('&lt;strong&gt;ERROR&lt;/strong&gt;: Registration halted, please contact support.','mydomain') );
            error_log('SPAMALERT: [email:' . $user_email . ', IP Address: ' .  $ip .']');
        } else { 
            error_log('NEWUSER: [email:' . $user_email . ', IP Address: ' .  $ip .']');
        }
    }

    return $errors;
}

add_filter('registration_errors', 'my_simple_domain_check', 10, 3);
</code></pre>
   <p>
    Simply add problematic domain names into the
    <code>
     $spamdomains
    </code>
    variable and users 
will not be able to register from those names. If you notice that a lot of those 
spam users are coming from a single IP address, than you can use something like
    <a href="http://www.cyberciti.biz/faq/linux-howto-check-ip-blocked-against-iptables/">
     iptables
    </a>
    to drop their packets. The
    <code>
     X-Forwarded-For
    </code>
    header is checked first 
because if you're behind a load balancer this is where the real ip address will be 
(the
    <code>
     remote_addr
    </code>
    will be the ip of the load balancer and you don't want to ban 
that!)
   </p>
   <p>
    I might create a simple plugin that creates a friendlier interface to non-programmers 
that logs the information to a database instead of the error log. Having a relatively 
clean error log can be important. After all, exceptions should be exceptional.
   </p>
   <h3>
    Other Posts
   </h3>
   <div id="other-posts">
    <ul>
     <li>
      <a href="registration-denial-plugin">
       Plugin to Ban users and deny registration in WordPress
      </a>
     </li>
     <li>
      <a href="exifstrip-context-nautilus">
       Context Menu Button to remove Exif Metadata
      </a>
     </li>
     <li>
      <a href="mysql-upstart-without-purge">
       Stopping mysql Upstart issues without reinstalling
      </a>
     </li>
     <li>
      <a href="change-wp-login-wp">
       Change Wordpress login URL
      </a>
     </li>
     <li>
      <a href="installing-gentoo-virtualbox">
       Attempting to install Gentoo into VirtualBox
      </a>
     </li>
     <li>
      <a href="rss-feed-with-harp">
       Create an RSS feed with Harp
      </a>
     </li>
    </ul>
   </div>
   <div id="disqus_thread">
   </div>
   <script type="text/javascript">
    var disqus_shortname = 'ejehardenberg';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
   </script>
   <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
     comments powered by Disqus.
    </a>
   </noscript>
   <a class="dsq-brlink" href="http://disqus.com">
    <!--
-->
    comments powered by
    <span class="logo-disqus">
     Disqus
    </span>
   </a>
  </div>
  <nav>
   <ul>
    <li>
     <a href="/index">
      <img height="32px" src="//static1.ethanjoachimeldridge.info/california.jpg" width="32px"/>
      <!--
-->
      <span>
       Home
      </span>
     </a>
    </li>
    <li>
     <a href="/about">
      <img height="32px" src="//static2.ethanjoachimeldridge.info/ethan.jpeg" width="32px"/>
      <!--
-->
      <span>
       About me
      </span>
     </a>
    </li>
    <li>
     <a href="/projects">
      <img height="32px" src="//static3.ethanjoachimeldridge.info/project.png" width="32px"/>
      <!--
-->
      <span>
       Projects
      </span>
     </a>
    </li>
    <li>
     <a href="/resume">
      <img height="32px" src="//static4.ethanjoachimeldridge.info/cv.png" width="32px"/>
      <!--
-->
      <span>
       Resume
      </span>
     </a>
    </li>
    <li>
     <a href="/tech-blog">
      <img height="32px" src="//static5.ethanjoachimeldridge.info/tech-blog.png" width="32px"/>
      <!--
-->
      <span>
       Tech Blog
      </span>
     </a>
    </li>
    <li>
     <a href="/cooking">
      <img height="32px" src="//static6.ethanjoachimeldridge.info/cooking.jpg" width="32px"/>
      <!--
-->
      <span>
       Cooking
      </span>
     </a>
    </li>
    <li>
     <a href="/writing">
      <img height="32px" src="//static7.ethanjoachimeldridge.info/writing.png" width="32px"/>
      <!--
-->
      <span>
       Writing
      </span>
     </a>
    </li>
    <li>
     <a href="/contact">
      <img height="32px" src="//static.ethanjoachimeldridge.info/contact.png" width="32px"/>
      <!--
-->
      <span>
       Contact
      </span>
     </a>
    </li>
    <li>
     <a href="/writing/political">
      <img height="32px" src="//static1.ethanjoachimeldridge.info/politics.png" width="32px"/>
      <!--
-->
      <span>
       Opinion
      </span>
     </a>
    </li>
    <li>
     <a href="https://github.com/EdgeCaseBerg">
      <img height="32px" src="//static2.ethanjoachimeldridge.info/github.png" width="32px"/>
      <!--
-->
      <span>
       Github
      </span>
     </a>
    </li>
    <li>
     <a href="https://twitter.com/TheR3dLily">
      <img height="32px" src="//static3.ethanjoachimeldridge.info/twitter-bird-light-bgs.png" width="32px"/>
      <!--
-->
      <span>
       @TheR3dLily
      </span>
     </a>
    </li>
    <li>
     <a href="http://www.linkedin.com/profile/view?id=151414806">
      <img height="32px" src="//static4.ethanjoachimeldridge.info/LinkedIn_logo.png" width="32px"/>
      <!--
-->
      <span>
       LinkedIn
      </span>
     </a>
    </li>
   </ul>
  </nav>
 </body>
</html>