<!DOCTYPE HTML>
<html>
 <head>
  <title>
   Ethan's Tech Blog | Use Native Library Classes in XML Beans (OpenCV)
  </title>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="With normal Java classes you can use System.loadLibrary to use native libraries, but what do you do when you're configuring classes via XML?" name="description"/>
  <meta content="Ethan Eldridge" name="author"/>
  <meta content="OpenCV,XML,Configuration,loadLibrary,Spring,UnsatisfiedLinkError,Native,JNI,Bean,Java,instantiate,dependency,Batch" name="keywords"/>
  <meta content="index, follow" name="robots"/>
  <meta content="1 month" name="revisit-after"/>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="icon" type="image/ico"/>
  <!-- Facebook Open Graph Tags -->
  <meta content="Ethan Eldridge | Use Native Library Classes in XML Beans (OpenCV)" property="og:title"/>
  <meta content="article" property="og:type"/>
  <meta content="//static2.ethanjoachimeldridge.info/ethan.jpeg" property="og:image"/>
  <meta content="http://www.ethanjoachimeldridge.info/" property="og:url"/>
  <meta content="With normal Java classes you can use System.loadLibrary to use native libraries, but what do you do when you're configuring classes via XML?" property="og:description"/>
  <!-- Twitter Card Tags -->
  <meta content="summary" name="twitter:card"/>
  <meta content="Ethan Eldridge | Use Native Library Classes in XML Beans (OpenCV)" name="twitter:title"/>
  <meta content="With normal Java classes you can use System.loadLibrary to use native libraries, but what do you do when you're configuring classes via XML?" name="twitter:description"/>
  <meta content="//static2.ethanjoachimeldridge.info/ethan.jpeg" name="twitter:image"/>
  <!-- Core CSS Scripts -->
  <link href="//css.ethanjoachimeldridge.info/style.css" integrity="sha384-N5yYwPDw4cymKjw0SjwRTKGAR4pv2PWn7wUtflWwszx/tkL1rEaVQyalmX2tM3wO" rel="stylesheet"/>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52103053-1', 'www.ethanjoachimeldridge.info');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
  </script>
 </head>
 <body>
  <header>
   <h1>
    Use Native Library Classes in XML Beans (OpenCV)
   </h1>
  </header>
  <div id="content">
   <a href="/tech-blog">
    Back
   </a>
   <h3>
    Use OpenCV Classes in Spring Bean XML Configuration
   </h3>
   <p>
    Today I ran into an infuriating issue that lasted for several hours. Here's the 
stack trace I was given when trying to run
    <code>
     mvn tomcat:run
    </code>
    :
   </p>
   <pre><code>Caused by: org.springframework.beans.BeanInstantiationException: Could not instantiate bean class [org.opencv.ml.CvSVM]: Constructor threw exception; nested exception is java.lang.UnsatisfiedLinkError: org.opencv.ml.CvSVM.CvSVM_0()J
        at org.springframework.beans.BeanUtils.instantiateClass(BeanUtils.java:162)
        at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:76)
        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateBean(AbstractAutowireCapableBeanFactory.java:990)
        ... 56 more
Caused by: java.lang.UnsatisfiedLinkError: org.opencv.ml.CvSVM.CvSVM_0()J
    at org.opencv.ml.CvSVM.CvSVM_0(Native Method)
    at org.opencv.ml.CvSVM.&lt;init&gt;(CvSVM.java:63)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)
    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
    at java.lang.reflect.Constructor.newInstance(Constructor.java:534)
    at org.springframework.beans.BeanUtils.instantiateClass(BeanUtils.java:147)
    ... 58 more
</code></pre>
   <p>
    Linker errors are normally because you failed to call
    <code>
     System.loadLibrary
    </code>
    and
then your JNI fails since it knows about your classes via the Jar wrappers around
the native code (and will compile) but at runtime you're out of luck. My problem 
was doubly more confusing because at runtime my
    <a href="http://docs.opencv.org/">
     OpenCV
    </a>
    code worked fine, but 
stopped when I tried to put one of the classes into an XML bean. Then the error 
above happened.
   </p>
   <p>
    So how do you fix it? Simple, you need to call
    <code>
     System.loadLibrary
    </code>
    ...
    <strong>
     from 
the XML
    </strong>
    . But how to do this obvious thing? For classes that depend on native
libraries the general pattern you do is the following:
   </p>
   <pre><code>import some.native.library.*;
public class SomethingThatNeedsNativeSupport {
    static {
        System.loadLibrary(NATIVE_LIBRARY_NAME);
    }
}
</code></pre>
   <p>
    But for XML configuration? It's surprisingly difficult to google for, and it wasn't
until I talked to one of my coworkers about the issue that he told me the obvious
answer: The
    <a href="http://docs.spring.io/spring/docs/2.5.3/reference/beans.html">
     depends-on property
    </a>
    pointed at a loader class.
   </p>
   <p>
    I had already thought to box the classes that were failing as beans in my own 
wrapper implementations since I could run the classes fine in the actual Java code
(luckily I didn't have
    <a href="http://stackoverflow.com/questions/3155589/java-lang-unsatisfiedlinkerror-under-tomcat">
     this guys issue
    </a>
    ), but a loader class was way easier, and
now I can use XML to configure the OpenCV classes. Here's the code:
   </p>
   <pre><code>//OpenCVLoader.java
package info.ethanjoachimeldridge.cv;
import org.opencv.core.*;

public class OpenCVLoader {
     static {
        System.loadLibrary(Core.NATIVE_LIBRARY_NAME);
    }
}
</code></pre>
   <p>
    Throw that into your package and then do something like the following in your XML:
   </p>
   <pre><code>&lt;bean id="cvLibLoader" class="info.ethanjoachimeldridge.cv.OpenCVLoader" /&gt;
&lt;bean id="svm" class="org.opencv.ml.CvSVM" depends-on="cvLibLoader"/&gt;
</code></pre>
   <p>
    The
    <code>
     depends-on
    </code>
    property of the bean will force that bean to be initialized before
the other, and therefore the library will be loaded when Spring gets around to 
loading the class.
   </p>
   <p>
    Hope this helps anyone else out there who's using
    <a href="http://projects.spring.io/spring-batch/">
     Spring Batch
    </a>
    and
    <a href="http://docs.opencv.org/">
     OpenCV
    </a>
    together.
   </p>
   <h3>
    Other Posts
   </h3>
   <div id="other-posts">
    <ul>
     <li>
      <a href="ambiguous-columns-namedparameterjdbc-order-by">
       Dynamic Tablename's in Order By with NamedParameterJdbc
      </a>
     </li>
     <li>
      <a href="order-by-rand-mysql">
       Order by Rand without a starting ID of 1
      </a>
     </li>
     <li>
      <a href="arcstar-chrome-extensions">
       *Arc: My First Chrome Extension
      </a>
     </li>
     <li>
      <a href="today-we-learned-through-games">
       Teaching Through Games
      </a>
     </li>
     <li>
      <a href="shared-voice">
       Shared Voice - Activist's tool
      </a>
     </li>
     <li>
      <a href="upgrading-chromium-33-to-37">
       Fixing the flash player in Chromium Version 37
      </a>
     </li>
    </ul>
   </div>
   <div id="disqus_thread">
   </div>
   <script type="text/javascript">
    var disqus_shortname = 'ejehardenberg';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
   </script>
   <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
     comments powered by Disqus.
    </a>
   </noscript>
   <a class="dsq-brlink" href="http://disqus.com">
    <!--
-->
    comments powered by
    <span class="logo-disqus">
     Disqus
    </span>
   </a>
  </div>
  <nav>
   <ul>
    <li>
     <a href="/index">
      <img height="32px" src="//static1.ethanjoachimeldridge.info/california.jpg" width="32px"/>
      <!--
-->
      <span>
       Home
      </span>
     </a>
    </li>
    <li>
     <a href="/about">
      <img height="32px" src="//static2.ethanjoachimeldridge.info/ethan.jpeg" width="32px"/>
      <!--
-->
      <span>
       About me
      </span>
     </a>
    </li>
    <li>
     <a href="/projects">
      <img height="32px" src="//static3.ethanjoachimeldridge.info/project.png" width="32px"/>
      <!--
-->
      <span>
       Projects
      </span>
     </a>
    </li>
    <li>
     <a href="/resume">
      <img height="32px" src="//static4.ethanjoachimeldridge.info/cv.png" width="32px"/>
      <!--
-->
      <span>
       Resume
      </span>
     </a>
    </li>
    <li>
     <a href="/tech-blog">
      <img height="32px" src="//static5.ethanjoachimeldridge.info/tech-blog.png" width="32px"/>
      <!--
-->
      <span>
       Tech Blog
      </span>
     </a>
    </li>
    <li>
     <a href="/cooking">
      <img height="32px" src="//static6.ethanjoachimeldridge.info/cooking.jpg" width="32px"/>
      <!--
-->
      <span>
       Cooking
      </span>
     </a>
    </li>
    <li>
     <a href="/writing">
      <img height="32px" src="//static7.ethanjoachimeldridge.info/writing.png" width="32px"/>
      <!--
-->
      <span>
       Writing
      </span>
     </a>
    </li>
    <li>
     <a href="/contact">
      <img height="32px" src="//static.ethanjoachimeldridge.info/contact.png" width="32px"/>
      <!--
-->
      <span>
       Contact
      </span>
     </a>
    </li>
    <li>
     <a href="/writing/political">
      <img height="32px" src="//static1.ethanjoachimeldridge.info/politics.png" width="32px"/>
      <!--
-->
      <span>
       Opinion
      </span>
     </a>
    </li>
    <li>
     <a href="https://github.com/EdgeCaseBerg">
      <img height="32px" src="//static2.ethanjoachimeldridge.info/github.png" width="32px"/>
      <!--
-->
      <span>
       Github
      </span>
     </a>
    </li>
    <li>
     <a href="https://twitter.com/TheR3dLily">
      <img height="32px" src="//static3.ethanjoachimeldridge.info/twitter-bird-light-bgs.png" width="32px"/>
      <!--
-->
      <span>
       @TheR3dLily
      </span>
     </a>
    </li>
    <li>
     <a href="http://www.linkedin.com/profile/view?id=151414806">
      <img height="32px" src="//static4.ethanjoachimeldridge.info/LinkedIn_logo.png" width="32px"/>
      <!--
-->
      <span>
       LinkedIn
      </span>
     </a>
    </li>
   </ul>
  </nav>
 </body>
</html>