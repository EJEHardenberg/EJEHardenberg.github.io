<!DOCTYPE HTML>
<html>
 <head>
  <title>
   Ethan's Tech Blog | Multiple Deploy Keys and Jenkins
  </title>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="Setting up multiply deploy keys and continous integration in jenkins with github." name="description"/>
  <meta content="Ethan Eldridge" name="author"/>
  <meta content="jenkins,git,deploy keys,multiple,continous,integration" name="keywords"/>
  <meta content="index, follow" name="robots"/>
  <meta content="1 month" name="revisit-after"/>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="icon" type="image/ico"/>
  <!-- Facebook Open Graph Tags -->
  <meta content="Ethan Eldridge | Multiple Deploy Keys and Jenkins" property="og:title"/>
  <meta content="article" property="og:type"/>
  <meta content="//static.ethanjoachimeldridge.info/ethan.jpeg" property="og:image"/>
  <meta content="http://www.ethanjoachimeldridge.info/" property="og:url"/>
  <meta content="Setting up multiply deploy keys and continous integration in jenkins with github." property="og:description"/>
  <!-- Twitter Card Tags -->
  <meta content="summary" name="twitter:card"/>
  <meta content="Ethan Eldridge | Multiple Deploy Keys and Jenkins" name="twitter:title"/>
  <meta content="Setting up multiply deploy keys and continous integration in jenkins with github." name="twitter:description"/>
  <meta content="//static.ethanjoachimeldridge.info/ethan.jpeg" name="twitter:image"/>
  <!-- Core CSS Scripts -->
  <link href="https://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet" type="text/css"/>
  <link crossorigin="anonymous" href="//css.ethanjoachimeldridge.info/style.css" integrity="sha384-Yk6fMSCCTCPyHYaY4h661zZEU59LSxS2pX0b+B1jG+4atCz2yx/YhiimkVlATCwk" rel="stylesheet"/>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52103053-1', 'www.ethanjoachimeldridge.info');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
  </script>
 </head>
 <body>
  <header>
   <h1>
    Multiple Deploy Keys and Jenkins
   </h1>
  </header>
  <div id="content">
   <a href="/tech-blog">
    Back
   </a>
   <h3>
    Jenkins Multiple Deploy Keys and Github Hooks
   </h3>
   <p>
    The other day I ran into an annoying issue. And it's such common one that
    <a href="https://help.github.com/articles/error-key-already-in-use/">
     github has a page for it
    </a>
    . I was setting up an application for continous 
integration. The common components were there. Application,
    <a href="https://jenkins-ci.org/">
     Jenkins
    </a>
    ,
and
    <a href="https://git-scm.com/">
     a VCS
    </a>
    , and there I was with an error. The issue is that you can't 
have a deploy key in use by multiple repositories.
    <a href="https://developer.github.com/guides/managing-deploy-keys/#machine-users">
     Github suggests using machine users
    </a>
    but that's a bit of a pain in my opinion. As I rather manage everything 
from the server.
   </p>
   <h4>
    Multiple SSH Keys and Jenkins
   </h4>
   <p>
    So the way around this is to setup a deploy key for each project. This 
is easily done with the command:
   </p>
   <pre><code>ssh-keygen -t rsa -f &lt;filename&gt;
</code></pre>
   <p>
    Since these are keys that will be used by machines, you'll want to leave 
the password  blank or you'll get some annoying issues to deal with later.
So, with that in mind become your jenkins user and create one!
   </p>
   <pre><code>su jenkins #login as jenkins
cd #change to jenkins's home directory
ssh-keygen -t rsa -f .ssh/id_rsa_myreponame    
</code></pre>
   <p>
    Next we'll do the "magic" here, open up your SSH configuration file like so
    <code>
     vi .ssh/config
    </code>
    and enter:
   </p>
   <pre><code>Host myrepo
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_rsa_myreponame
</code></pre>
   <p>
    Now that that's in place you can test the connection:
   </p>
   <pre><code>ssh -T myrepo
</code></pre>
   <p>
    And you'll get back the usual "You've successfully authenticated, but GitHub 
does not provide shell access." So you're halfway there. The next thing you 
should do is go to your Jenkins server, the job configuration you're working 
on, and update the github urls to use your new host. For example, if you're 
using the
    <a href="https://wiki.jenkins-ci.org/display/JENKINS/GitHub+Plugin">
     Github Plugin for jenkins
    </a>
    you'll update the
    <strong>
     Github project
    </strong>
    area to
say:
    <code>
     myrepo/username/repository/
    </code>
    . And if you're using the
    <a href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin">
     Git plugin
    </a>
    you'll
update the
    <strong>
     Source Code Management -&gt; Repository URL
    </strong>
    area to say:
    <code>
     myrepo/username/repo.git
    </code>
    and set the
    <strong>
     credentials
    </strong>
    area to use the ssh file you just made.
   </p>
   <p>
    Once you do that and add the SSH key as a deploy key to github, you're done if you
just want to have the one jenkins server talk to multiple github projects. But wait,
there's more!
   </p>
   <h4>
    What about continous integration?
   </h4>
   <p>
    When it comes to the Github Jenkins Plugin, you're out of luck as far as I know. 
Because the
    <code>
     /github-plugin
    </code>
    hook, is sent the
    <em>
     Github version of the url
    </em>
    in the
post data. You'll see nice errors like this in your logfile:
   </p>
   <pre><code>INFO: Received POST for https://github.com/username/repo
Aug 21, 2015 1:53:25 PM com.cloudbees.jenkins.GitHubRepositoryName create
WARNING: Could not match URL myrepo:username/repo.git
Aug 21, 2015 1:53:25 PM com.cloudbees.jenkins.GitHubWebHook processGitHubPayload
INFO: Poked Specification Build
</code></pre>
   <p>
    But, if you're using the git plugin you're in luck because the
    <a href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin#GitPlugin-Pushnotificationfromrepository">
     push notification
    </a>
    takes a
    <code>
     url=
    </code>
    parameter that you can use to specify your customized url in. The 
useful thing (and I'm not sure if it's
    <em>
     supposed
    </em>
    to do this, but it does) is this
endpoint responds to both GET and POST requests the same way. So you can go to your 
github repository settings and add a WebHook with the specified url:
   </p>
   <pre><code>http://yourserver/git/notifyCommit?url=&lt;URL of the Git repository&gt;
</code></pre>
   <p>
    To the Jenkins Hook URL field in the settings for the jenkins web hooks. And then you
should see builds when you push to your repository!
   </p>
   <h3>
    Other Posts
   </h3>
   <div id="other-posts">
    <ul>
     <li>
      <a href="compromising-wordpress">
       WordPress 4.2 Exploit, SQL Injection Edition
      </a>
     </li>
     <li>
      <a href="protecting-proxied-servers">
       Administrative Gotcha when doing local proxying
      </a>
     </li>
     <li>
      <a href="newrelic-xml-scala-instrumentation">
       NewRelic, Scala, and XML Instrumentation
      </a>
     </li>
     <li>
      <a href="spray-transparent-head-requests-testing">
       Spray's Transparent Head Requests and Testing
      </a>
     </li>
     <li>
      <a href="spray-ToResponseMarshallable-too-many-arguments-error">
       Spray ToResponseMarshallable "Too Many Arguments" error
      </a>
     </li>
     <li>
      <a href="logging-to-a-file-spray-async">
       Logging to a File in Spray
      </a>
     </li>
    </ul>
   </div>
   <div id="disqus_thread">
   </div>
   <script type="text/javascript">
    var disqus_shortname = 'ejehardenberg';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
   </script>
   <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
     comments powered by Disqus.
    </a>
   </noscript>
   <a class="dsq-brlink" href="http://disqus.com">
    <!--
-->
    comments powered by
    <span class="logo-disqus">
     Disqus
    </span>
   </a>
  </div>
  <nav>
   <ul>
    <li>
     <a href="/index">
      <span>
       Home
      </span>
     </a>
    </li>
    <li>
     <a href="/about">
      <span>
       About me
      </span>
     </a>
    </li>
    <li>
     <a href="/projects">
      <span>
       Projects
      </span>
     </a>
    </li>
    <li>
     <a href="/resume">
      <span>
       Resume
      </span>
     </a>
    </li>
    <li>
     <a href="/tech-blog">
      <span>
       Tech Blog
      </span>
     </a>
    </li>
    <li>
     <a href="/cooking">
      <span>
       Cooking
      </span>
     </a>
    </li>
    <li>
     <a href="/writing">
      <span>
       Writing
      </span>
     </a>
    </li>
    <li>
     <a href="/contact">
      <span>
       Contact
      </span>
     </a>
    </li>
    <li>
     <a href="/writing/political">
      <span>
       Opinion
      </span>
     </a>
    </li>
    <li>
     <a href="https://github.com/EdgeCaseBerg">
      <span>
       Github
      </span>
     </a>
    </li>
    <li>
     <a href="https://twitter.com/TheR3dLily">
      <span>
       Twitter
      </span>
     </a>
    </li>
    <li>
     <a href="http://www.linkedin.com/profile/view?id=151414806">
      <span>
       LinkedIn
      </span>
     </a>
    </li>
   </ul>
  </nav>
 </body>
</html>