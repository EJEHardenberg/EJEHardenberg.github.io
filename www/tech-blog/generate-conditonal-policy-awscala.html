<!DOCTYPE HTML>
<html>
 <head>
  <title>
   Ethan's Tech Blog | Generate Conditional AWS Group Policies with AWScala
  </title>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <meta content="How to programmatically generate a policy containing conditionals for AWS group S3 access with AWScala" name="description"/>
  <meta content="Ethan Eldridge" name="author"/>
  <meta content="awscala, condition, policy, scala, aws, amazon" name="keywords"/>
  <meta content="index, follow" name="robots"/>
  <meta content="1 month" name="revisit-after"/>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="//static.ethanjoachimeldridge.info/favicon.ico" rel="icon" type="image/ico"/>
  <!-- Facebook Open Graph Tags -->
  <meta content="Ethan Eldridge | Generate Conditional AWS Group Policies with AWScala" property="og:title"/>
  <meta content="article" property="og:type"/>
  <meta content="//static.ethanjoachimeldridge.info/ethan.jpeg" property="og:image"/>
  <meta content="http://www.ethanjoachimeldridge.info/" property="og:url"/>
  <meta content="How to programmatically generate a policy containing conditionals for AWS group S3 access with AWScala" property="og:description"/>
  <!-- Twitter Card Tags -->
  <meta content="summary" name="twitter:card"/>
  <meta content="Ethan Eldridge | Generate Conditional AWS Group Policies with AWScala" name="twitter:title"/>
  <meta content="How to programmatically generate a policy containing conditionals for AWS group S3 access with AWScala" name="twitter:description"/>
  <meta content="//static.ethanjoachimeldridge.info/ethan.jpeg" name="twitter:image"/>
  <!-- Core CSS Scripts -->
  <link href="https://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet" type="text/css"/>
  <link crossorigin="anonymous" href="//css.ethanjoachimeldridge.info/style.css" integrity="sha384-Yk6fMSCCTCPyHYaY4h661zZEU59LSxS2pX0b+B1jG+4atCz2yx/YhiimkVlATCwk" rel="stylesheet"/>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52103053-1', 'www.ethanjoachimeldridge.info');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
  </script>
 </head>
 <body>
  <header>
   <h1>
    Generate Conditional AWS Group Policies with AWScala
   </h1>
  </header>
  <div id="content">
   <a href="/tech-blog">
    Back
   </a>
   <h3>
    Generating a conditonal policy with AWScala
   </h3>
   <p>
    One of the benefits of Amazon Web Services is the
    <a href="http://aws.amazon.com/iam/">
     IAM system
    </a>
    . This 
handy interface can be used to give people within, or outside, of your 
organization access to the console or content. Here's an example that 
is fairly common.
   </p>
   <p>
    A tech-smart photographer takes his photo's with a high resolution 
camera and needs to deliver a few Gigabytes of data to a client. He has 
a few options: get a portalble hard-drive and hand the files over 
directly; upload the images to a private service and send the links to 
the client; or use something like dropbox to transfer the files over.
   </p>
   <p>
    Let's say the client isn't tech savvy enough to pull out the information 
from the hard-drives and they don't trust dropbox. So instead, the 
photographer tells them about his AWS S3 Bucket and provides a login for 
them to use. All good right? The client connects, navigates the S3 
interface like it was their usual file explorer, and downloads the images.
   </p>
   <p>
    But wait. What if the photographer has more than one client? How does he 
prevent one client from downloading another's work? After all, each client 
is only entitled to the work they've paid him for and no more.
   </p>
   <p>
    Enter
    <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/policies_overview.html">
     Policies
    </a>
    .
   </p>
   <p>
    Using a policy it's not too hard to restrict access to a single folder* 
inside of a bucket. Here's the gist of it:
   </p>
   <pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowGroupToSeeBucketListAndAlsoAllowGetBucketLocationRequiredForListBucket",
            "Action": [
                "s3:ListAllMyBuckets",
                "s3:GetBucketLocation"
            ],
            "Effect": "Allow",
            "Resource": [
                "arn:aws:s3:::*",
                "arn:aws:s3:::my-bucket"
            ]
        },
        {
            "Sid": "AllowListBucketIfSpecificPrefixIsIncludedInRequest",
            "Action": [
                "s3:ListBucket"
            ],
            "Effect": "Allow",
            "Resource": [
                "arn:aws:s3:::my-bucket"
            ],
            "Condition" : {
                "StringLike" : {
                    "s3:prefix" : ["","ClientOne/*"]
                }
            }
        },
        {
            "Sid": "AllowUserToReadObjectDataInClientsFolder",
            "Action": [
                "s3:GetObject"
            ],
            "Effect": "Allow",
            "Resource": [
                "arn:aws:s3:::my-bucket/ClientOne/*"
            ]
        },
        {
            "Sid": "ExplicitlyDenyAnyRequestsForAllOtherFoldersExceptForclients",
            "Action": [
                "s3:ListBucket"
            ],
            "Effect": "Deny",
            "Resource": [
                "arn:aws:s3:::my-bucket"
            ],
            "Condition": {
                "StringNotLike": {
                    "s3:prefix": [
                        "",
                        "ClientOne/*"
                    ]
                }
            }
        }
    ]
}
</code></pre>
   <p>
    Ok, so maybe not the briefest things. But it's fairly clear what the 
policy does when you exam it. There are 4 statements. The first 2 
deal with access to the bucket and listing the contents. The third 
allows a user to download an object from the bucket. Last, the fourth 
denies access to any other bucket or folder if it doesn't match our 
specified folder.
   </p>
   <p>
    While it's fun to write out the JSON by hand, or to use the
    <a href="http://awspolicygen.s3.amazonaws.com/policygen.html">
     generator
    </a>
    that amazon provides. It's a bit faster to do this programmatically then 
it is to navigate all the screens inside the Amazon console. Using the
    <a href="https://github.com/seratch/AWScala">
     AWScala
    </a>
    library, we can create the same policy as above in code:
   </p>
   <pre><code>val sidName = "SomeNameYouWouldMake"
val bucketName = "my-bucket"
val keyToAllow = "ClientOne/" //
val policy = Policy(
    Seq(
        Statement(Effect.Allow, 
            Seq(
                Action("s3:ListAllMyBuckets"), 
                Action("s3:GetBucketLocation")
            ),
            Seq(
                Resource("arn:aws:s3:::*"),
                Resource(s"arn:aws:s3:::${bucketName}")
            ),
            id = Some(s"AllowGroupToSeeBucketListAndAlsoAllowGetBucketLocationRequiredForListBucket${sidName}")
        ),
        Statement(Effect.Allow,
            Seq(
                Action("s3:ListBucket")
            ),
            Seq(
                Resource(s"arn:aws:s3:::${bucketName}")
            ),
            id = Some(s"AllowListBucketIfSpecificPrefixIsIncludedInRequest${sidName}"),
            conditions = Seq(
                new awscala.Condition(                            
                    "s3:prefix",
                    "StringLike",
                    Seq("", s"${keyToAllow}*")
                )
            )
        ),
        Statement(Effect.Allow, 
            Seq(
                Action(
                    "s3:GetObject"
                )
            ),
            Seq(
                Resource(
                    s"arn:aws:s3:::${bucketName}/${keyToAllow}*"
                )
            ),
            id = Some(s"AllowUserToReadObjectDataInFolderFor${sidName}")
        ),
        Statement(Effect.Deny,
            Seq(
                Action(
                    "s3:ListBucket"
                )
            ),
            Seq(
                Resource(
                    s"arn:aws:s3:::${bucketName}"
                )
            ),
            id = Some(s"ExplicitlyDenyAnyRequestsForAllOtherFoldersExcept${sidName}"),
            conditions = Seq(
                new awscala.Condition(
                    "s3:prefix",
                    "StringNotLike",
                    Seq("", s"${keyToAllow}*")
                )
            )
        )
    )
)
</code></pre>
   <p>
    You don't
    <em>
     have
    </em>
    to set the
    <code>
     id
    </code>
    in the
    <code>
     Statement
    </code>
    s. But if you want 
them to mean something to you if you ever look into your group's policies 
then you should consider it.
   </p>
   <p>
    You may notice that the
    <code>
     Condition
    </code>
    is created using
    <code>
     new
    </code>
    unlike the 
other parts of the policy. This is doe to an
    <a href="https://github.com/seratch/AWScala/issues/83">
     inconsitency that has since been fixed
    </a>
    . 
If you haven't tried out
    <a href="https://github.com/seratch/AWScala">
     AWScala
    </a>
    , you should give it a try. The source 
code is clear enough most of the time that you can figure out how to do 
things quickly. The examples given in the
    <a href="https://github.com/seratch/AWScala/blob/master/README.md">
     README
    </a>
    provide common use cases 
that should be good for most people. There's no conditional policy example, 
but you're welcome to use the one above as a starting point!
   </p>
   <h3>
    Other Posts
   </h3>
   <div id="other-posts">
    <ul>
     <li>
      <a href="manipulating-XML-with-PHP">
       Manipulating XML with PHP
      </a>
     </li>
     <li>
      <a href="reverse-routing-package-controller">
       Reverse routing with non-standard controller packages in Play
      </a>
     </li>
     <li>
      <a href="could-not-instantiate-SVGImageReader-Scrimage">
       Scala Scrimage error solution: the org.apache.batik.transcoder.TranscoderException
      </a>
     </li>
     <li>
      <a href="triggering-asynchronous-jobs-play-2-3">
       Trigger Asynchronous Jobs in Play 2.3
      </a>
     </li>
     <li>
      <a href="none-in-default-fold-and-type-erasure">
       Type Error when using None as a default to Option.fold
      </a>
     </li>
     <li>
      <a href="non-empty-lists-validation-in-playframework">
       Non Empty List Form Validation in Play
      </a>
     </li>
    </ul>
   </div>
   <div id="disqus_thread">
   </div>
   <script type="text/javascript">
    var disqus_shortname = 'ejehardenberg';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
   </script>
   <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
     comments powered by Disqus.
    </a>
   </noscript>
   <a class="dsq-brlink" href="http://disqus.com">
    <!--
-->
    comments powered by
    <span class="logo-disqus">
     Disqus
    </span>
   </a>
  </div>
  <nav>
   <ul>
    <li>
     <a href="/index">
      <span>
       Home
      </span>
     </a>
    </li>
    <li>
     <a href="/about">
      <span>
       About me
      </span>
     </a>
    </li>
    <li>
     <a href="/projects">
      <span>
       Projects
      </span>
     </a>
    </li>
    <li>
     <a href="/resume">
      <span>
       Resume
      </span>
     </a>
    </li>
    <li>
     <a href="/tech-blog">
      <span>
       Tech Blog
      </span>
     </a>
    </li>
    <li>
     <a href="/cooking">
      <span>
       Cooking
      </span>
     </a>
    </li>
    <li>
     <a href="/writing">
      <span>
       Writing
      </span>
     </a>
    </li>
    <li>
     <a href="/contact">
      <span>
       Contact
      </span>
     </a>
    </li>
    <li>
     <a href="/writing/political">
      <span>
       Opinion
      </span>
     </a>
    </li>
    <li>
     <a href="https://github.com/EdgeCaseBerg">
      <span>
       Github
      </span>
     </a>
    </li>
    <li>
     <a href="https://twitter.com/TheR3dLily">
      <span>
       Twitter
      </span>
     </a>
    </li>
    <li>
     <a href="http://www.linkedin.com/profile/view?id=151414806">
      <span>
       LinkedIn
      </span>
     </a>
    </li>
   </ul>
  </nav>
 </body>
</html>